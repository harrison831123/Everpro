
@{
    string now = (DateTime.Now.Year - 1911) + DateTime.Now.ToString("MMdd");
}

<font color="red">@LAWResource.合併年度預設為95年起至所選擇年度</font>
<br>
<font color="blue">@LAWResource.清償金額分別以結案<br></font>
<form id="QueryRptForm" action="/LAWQU003/GetReport" method="post">
    <div class="col-md-12 form-group detail-col">
        <div class="col-md-12">
            <label class="control-label">@LAWResource.選擇合併年度</label>
            <br />
            <select id="LawYearType" class="form-control" name="LawYearType" style="width:30%">
                <option value="95">95</option>
                @for (var i = 96; i <= (DateTime.Now.Year - 1911); i++)
                {
                    <text>
                        <option value="@i">@i</option>
                    </text>
                }
            </select>
        </div>
        <div class="col-md-12" style="margin-top:10px">
            <button class="btn btn-default " id="btnInsert" onclick="GetLawSta()">@EP.PlatformResources.確定</button>
            <button class="btn btn-primary " id="btnInsertLog" onclick="InsertLawMasterReportLog()">@LAWResource.系統紀錄Log</button>
            <button class="btn btn-warning " id="btnInsertLog" onclick="GetReport()">@LAWResource.匯出報表</button>
        </div>
    </div>
</form>
    <div class="row col-md-12">
        <table id="datatable" class="table">
            <thead>
                <tr>
                    <td align="center">@LAWResource.總表</td>
                    <td align="center">@now</td>
                    <td align="center">@LAWResource.含續佣抵結欠</td>
                </tr>
            </thead>
            <tbody id="datatbody">
            </tbody>
        </table>
    </div>


    <script>
    @*var ViewModel = {
        InsertClick: function () {
            location.href = '@Url.Action("Create", "LAWQU003", new { area = "LAW" })';
        },
    }*@
    $(document).ready(function () {
        //ko.applyBindings(ViewModel);
        GetLawSta();
    });
    function GetLawSta() {
         $.ajax({
             method: "Post",
             cache: false,
             data: { year : $("#LawYearType").val()},
             url: '@Url.Action("_Statistics", "LAWQU003", new { area = "LAW" })',
             complete: function (data) {
                        console.log(data.responseJSON);
                        if (data.responseJSON === undefined) {
                        } else {
                            $("#datatbody").empty();
                            $.each(data.responseJSON, function () {
                                let sumyear,sumduemoney,repmoney,pst;
                                if ($("#LawYearType").val() == 95) {
                                    this.Lawyear = this.Lawyear == null ? 95 : this.Lawyear;
                                    sumyear = "<tr ><td></td><td>" + this.Lawyear + " @LAWResource.年度總計 / " + this.DateNow + "</td><td>" + this.DateHave + "</td></tr>"
                                } else if (this.sumtype == 1) {
                                    sumyear = "<tr><td></td><td>95 ~ " + this.year + " @LAWResource.年度總計 / " + this.DateNow + "</td><td>" + this.DateHave + "</td></tr>"
                                } else{
                                    sumyear = "<tr><td></td><td>" + this.Lawyear + " @LAWResource.年度總計 / " + this.DateNow +  "</td><td>" + this.DateHave + "</td></tr>"
                                }
                                if (this.LawDueMoney != null) {
                                    if (this.LawTotalDue != null) {
                                        sumduemoney = "<tr ><td>@LAWResource.結欠總金額</td><td>" + this.LawDueMoney + "</td><td>" + this.LawTotalDue + '</td></tr>';
                                    } else{
                                        sumduemoney = "<tr ><td>@LAWResource.結欠總金額</td><td>" + this.LawDueMoney + "</td>" + '</tr>';
                                    }
                                } else {
                                    sumduemoney = "<tr ><td>@LAWResource.結欠總金額</td><td></td><td></td></tr>"
                                }
                                if (this.LawRepaymentMoney != null) {
                                    if (this.LawTotalRepayment != null) {
                                        repmoney = "<tr ><td>@LAWResource.已清償本金累計金額</td><td>" + this.LawRepaymentMoney + "</td><td>" + this.LawTotalRepayment + '</td></tr>';
                                    } else {
                                        repmoney = "<tr ><td>@LAWResource.已清償本金累計金額</td><td>" + this.LawRepaymentMoney + "</td>" + '</tr>';
                                    }

                                } else{
                                    repmoney = "<tr ><td>@LAWResource.已清償本金累計金額</td><td></td>" + '</tr>';
                                }
                                pst = "<tr><td >@LAWResource.達成率【@LAWResource.金額】</td><td  bgcolor='#FFFF66'><font color=blue>" + this.pstr + "</font></td><td bgcolor='#FFFF66'><font color=blue>" + this.repayperstr + "</font></td></tr>";

                                let str = sumyear + sumduemoney + repmoney + pst + "<tr><td colspan=3>&nbsp;</td></tr>";

                                $("#datatbody").append(str);
                            });
                        }
             },
             error: function (ex) {
             if (ex.statusText == "OK") {
             } else {
                 appendMessage("@EP.PlatformResources.系統發生錯誤");
                 }
             }
         });
    }

    function InsertLawMasterReportLog() {
         $.ajax({
             method: "Post",
             cache: false,
             async: false,
             url: '@Url.Action("InsertLawMasterReportLog", "LAWQU003", new { area = "LAW" })',
             complete: function (data) {
                 location.reload();
             },
             error: function (ex) {
             if (ex.statusText == "OK") {
             } else {
                 appendMessage("@EP.PlatformResources.系統發生錯誤");
                 }
             }
         });
    }

    @*function GetReport() {
        clearMessage();
        var formData = new FormData();
        formData.append('LawYearType', $('#LawYearType').val());

        $.ajax({
            method: "POST",
            cache: false,
            url: '@Url.Action("GetReport", "LAWQU003", new { area = "LAW" })',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                window.location = '/LAW/LAWQU003/Download?fileGuid=' + data.FileGuid
                    + '&filename=' + data.FileName;
            },
            error: function () {
                appendMessage("@LAWResource.系統發生錯誤");
            }
        });
    }*@

    function GetTeamReport() {
        var url = $("form#QueryRptForm").attr('action');

        var dataJson = $("form#QueryRptForm").serializeArray();
        $.extend(
            {
                redirectPost: function (location, args) {
                    var form = '';
                    $.each(args, function (key, value) {
                        form += '<input type="hidden" name="' + value.name + '" value="' + value.value + '">';
                    });
                    $('<form action="' + location + '" method="POST">' + form + '</form>').appendTo('body').submit();
                }
            });

        $.redirectPost(url, dataJson);
    }
    </script>


