@{
    string now = (DateTime.Now.Year - 1911) + DateTime.Now.ToString("MMdd");
}

<font color="red">@LAWResource.合併年度預設為95年起至所選擇年度</font>
<br>
<font color="blue">@LAWResource.例如選擇97年<br></font>
<form id="QueryRptForm" action="/LAWQU003/TeamReport" method="post">
    <div class="col-md-12 form-group detail-col">
        <div class="col-md-12">
            <label class="control-label">@LAWResource.選擇合併年度</label>
            <br />
            <select id="LawYearType" class="form-control" name="LawYearType" style="width:30%">
                <option value="95">95</option>
                @for (var i = 96; i <= (DateTime.Now.Year - 1911); i++)
                {
                    <text>
                        <option value="@i">@i</option>
                    </text>
                }
            </select>
        </div>
        <div class="col-md-12" style="margin-top:10px">
            <input type="button" id="btnQuery" class="btn btn-default" value="@EP.PlatformResources.查詢" onclick="GetLawTeam()" />
        <button class="btn btn-warning " id="btnInsertLog" onclick="GetTeamReport()">@LAWResource.匯出報表</button>
        </div>
    </div>
</form>
<div class="row col-md-12">
    <table id="datatable" class="table">
        <thead id="datahead">
            <tr id="dataheadtr"></tr>
            <tr id="dataheadtr3"></tr>
        </thead>
        <tbody id="datatbody">
        </tbody>
    </table>
</div>
<script>
    $(document).ready(function () {
        GetLawTeam();
    });
    function GetLawTeam() {
         $.ajax({
             method: "POST",
             cache: false,
             data: { year : $("#LawYearType").val()},
             url: '@Url.Action("_TeamListReport", "LAWQU003", new { area = "LAW" })',
             complete: function (data) {
                if (data.responseJSON === undefined) {
                } else {
                    $("#dataheadtr").empty();
                    $("#dataheadtr3").empty();
                    $("#datatbody").empty();
                    let currentTime = new Date();
                    let year = currentTime.getFullYear();
                    let ii = 95;
                    let flag = 0;
                    let LawYearType = $("#LawYearType").val();
                    var vm_tmp;
                    //設定年度&標題
                    let unit = "<td rowspan='2' colspan='1'  valign='middle'>" + "單位" +"</td>";
                    $("#dataheadtr").append(unit);
                    for (var i = LawYearType; i <= year - 1911; i++) {
                        let sthead, stheadtr;
                        if (LawYearType == 95) {
                            stheadtr = "<td rowspan='1' colspan='3' >" + ii + "年度" + "</td>"
                            ii++;
                        } else if (LawYearType > 95 && flag == 0) {
                            stheadtr = "<td rowspan='1' colspan='3'  > 95 ~ " + LawYearType + "年度" + "</td>"
                            flag = 1;
                        } else {
                            LawYearType = parseInt(LawYearType) + 1;
                            stheadtr = "<td rowspan='1' colspan='3'  >" + LawYearType + "年度" + "</td>"
                        }
                        $("#dataheadtr").append(stheadtr);
                        sthead = "<td rowspan='1' colspan='1' >發函金額</td><td >追回本金金額</td><td >百分比</td></tr>"
                        $("#dataheadtr3").append(sthead);
                    }

                    //設定體系和資料
                    var tot_str;
                    $.each(data.responseJSON, function (index) {
                        let isLastElement = index == data.responseJSON.length - 1;
                        let vmname = this.VmName
                        let smname = this.SmName
                        let table_str;
                        if (vm_tmp != vmname) {
                            if (isLastElement) {

                            } else {
                                $("#datatbody").append(tot_str);
                                tot_str = ""
                            }
                        }
                        if (vmname == smname && smname == "公司") {
                            table_str = "<tr bgcolor='#FFFFCC'><td>" + "公司總計" + "</td>";
                        } else {
                            if (vmname == smname && (vmname.slice(-2) == "團隊" && smname.slice(-2) == "團隊") || (vmname != smname && (vmname.slice(-2) == "團隊" && smname.slice(-2) == "團隊"))) {
                                vm_tmp = vmname;
                                if (vmname == smname && (vmname.slice(-2) == "團隊" && smname.slice(-2) == "團隊")) {
                                    tot_str = "<tr bgcolor='#FFCC99'><td>" + smname + "小計" + "</td>";
                                } else {
                                    tot_str = "<tr bgcolor='#FFCC99'><td>" + vmname + "小計" + "</td>";
                                }
                            } else {
                                table_str = "<tr><td>" + smname + "</td>";
                            }
                        }
                        $.ajax({
                            method: "Post",
                            cache: false,
                            async: false,
                            data: { LawYear: $("#LawYearType").val(), VmName: this.VmName, SmName: this.SmName},
                            url: '@Url.Action("TeamListData", "LAWQU003", new { area = "LAW" })',
                            complete: function (dataa) {
                                if (dataa.responseJSON === undefined) {
                                } else {
                                    $.each(dataa.responseJSON, function () {
                                        let pstr = this.pstr;
                                        if (pstr > 100) {
                                            pstr = 100;
                                        }
                                        if (pstr >= 60) {
                                            pstr = "<font color=blue>" + pstr + "%</font>"
                                        }
                                        else if (pstr == "") {

                                        }
                                        else{
                                            pstr = "<font color=red>" + pstr + "%</font>"
                                        }

                                        if (vmname == smname && vmname != "公司" || (vmname != smname && (vmname.slice(-2) == "團隊" && smname.slice(-2) == "團隊"))) {
                                            tot_str += "<td>" + this.DueMoney + "</td><td>"
                                                + this.RepayMoney + "</td><td>"
                                                + pstr + "</td>";
                                        } else {
                                            if (vmname == smname && vmname == "公司") {
                                                table_str += "<td>"
                                                    + this.DueMoney + "</td><td>"
                                                    + this.RepayMoney + "</td><td>"
                                                    + pstr
                                                    + '</td>';
                                            } else {
                                                table_str += "<td>"
                                                    + this.DueMoney + "</td><td>"
                                                    + this.RepayMoney + "</td><td>"
                                                    + '</td>';
                                            }
                                        }

                                    });
                                }
                            }
                        });

                        if (vmname.slice(-2) == "團隊" && smname.slice(-2) == "團隊") {
                            tot_str += "</tr>"
                        } else {
                            table_str += "</tr>"
                            $("#datatbody").append(table_str);
                        }
                        if (isLastElement) {
                            $("#datatbody").append(tot_str);
                        }
                    });
                }
             },
             error: function (ex) {
             if (ex.statusText == "OK") {
             } else {
                 appendMessage("@EP.PlatformResources.系統發生錯誤");
                 }
             }
         });
    }
    function GetTeamReport() {
        var url = $("form#QueryRptForm").attr('action');

        var dataJson = $("form#QueryRptForm").serializeArray();
        $.extend(
            {
                redirectPost: function (location, args) {
                    var form = '';
                    $.each(args, function (key, value) {
                        form += '<input type="hidden" name="' + value.name + '" value="' + value.value + '">';
                    });
                    $('<form action="' + location + '" method="POST">' + form + '</form>').appendTo('body').submit();
                }
            });

        $.redirectPost(url, dataJson);
    }

</script>