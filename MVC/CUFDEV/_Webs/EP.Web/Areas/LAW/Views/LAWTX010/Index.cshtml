@model  EP.SD.SalesSupport.LAW.Models.LawSearchDetail
@{
    ViewBag.Title = LAWResource.電話催告通知;
    Layout = "~/Views/Shared/_LayoutMenu.cshtml";
}
<font color=blue>
    <p>@LAWResource.注意事項</p>
    <p>@LAWResource.電話催告作業請至法追進度表中執行</p>
    <p>@LAWResource.電話催告審閱完畢請點選更新按鈕</p>
</font>
@*查詢執行結果*@
@using (Ajax.BeginForm("Query", "LAWTX010", null, new AjaxOptions { OnSuccess = "BindGrid" }, new { id = "LawQuery", area = "LAWTX010" }))
{
    <div class="col-md-12 form-group detail-col">
        <div class="col-md-4">
            <label class="control-label">@LAWResource.選擇類別</label>
            <br />
            <select id="LawSearchType" class="form-control" name="LawSearchType">
                <option value="1">
                    @LAWResource.電話催告通知
                </option>
                <option value="2">@LAWResource.法催案件維護逾30日未異動通知</option>
            </select>
        </div>
        <div class="col-md-12" style="margin-top:10px">
            <input type="button" id="btnQuery" style="display:none" class="btn btn-default" value="@EP.PlatformResources.查詢" data-bind="hotkeydown: { 'alt+q': QueryClick }, click: QueryClick" />
            <input type="button" id="btnUpdate" class="btn btn-primary" value="@EP.PlatformResources.更新" data-bind="hotkeydown: { 'alt+q': UpdateClick }, click: UpdateClick" />
        </div>
    </div>
}
@section GridActions {
    <div class="jqGrid">
        <table id="Result"></table>
    </div>
    <div id="ResultPagger"></div>
}

@section Scripts{

    <script>
        var ViewModel = {
            QueryClick: function () {
                clearMessage();
                $("form#LawQuery").trigger("submit");
            },
            UpdateClick: function () {
                $.ajax({
                    method: "POST",
                    cache: false,
                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                    url: '@Url.Action("Update", "LAWTX010", new { area = "LAW" })',
                    complete: function (data) {
                        console.log(data.responseJSON);
                        alert("@EP.PlatformResources.更新成功");
                        $("#btnQuery").click();
                    },
                    error: function (ex) {
                    if (ex.statusText == "OK") {
                    } else {
                        appendMessage("@EP.PlatformResources.系統發生錯誤");
                        }
                    }
                });
            }
        };
        $(function () {
            ko.applyBindings(ViewModel);
            $("#btnQuery").click();
        });
        $('#LawSearchType').on('change', function () {
            $("#btnQuery").click();
        });
        function BindGrid() {
            if ($("#LawSearchType").val() == 1) {
                $("#Result").GridUnload();
                $("#Result").jqGrid({
                    url: '@Url.Action("BindGrid", "LAWTX010", new { area = "LAW" })',
                    datatype: "json",
                    mtype: "POST",
                    colNames: ["", "@LAWResource.照會單號", "@LAWResource.上次電催日期", "@LAWResource.本次應電催日期期限", "@LAWResource.承辦人"],
                    colModel: [
                        { name: "LawCallLogId", index: "LawCallLogId", hidden: true },
                        { name: "LawNoteNo", index: "LawNoteNo" },
                        { name: "LawPhoneCallDate", index: "LawPhoneCallDate", formatter: displayLawPhoneCallDate },
                        { name: "LawPhoneCallLimitedDate", index: "LawPhoneCallLimitedDate", formatter: displayLawPhoneCallLimitedDate },
                        { name: "LawDouserName", index: "LawDouserName" }
                    ],
                    jsonReader: {
                        repeatitems: false,
                        id: "0"
                    },
                    loadComplete: function () {
                        $('#Result').jqGrid("setGridWidth", $('#resultDIV').width());
                    },
                    pager: "ResultPagger"
                });
                $("#Result").trigger("reloadGrid");
            }  else {
                $("#Result").GridUnload();
                $("#Result").jqGrid({
                    url: '@Url.Action("BindGrid", "LAWTX010", new { area = "LAW" })',
                    datatype: "json",
                    mtype: "POST",
                    colNames: ["@LAWResource.照會單號", "@LAWResource.最後異動日期 ", "@LAWResource.承辦人"],
                    colModel: [
                        { name: "LawNoteNo", index: "LawNoteNo"},
                        { name: "LawContentLastchangeDate", index: "LawContentLastchangeDate" },
                        { name: "LawDouserName", index: "LawDouserName" }
                    ],
                    jsonReader: {
                        repeatitems: false,
                        id: "0"
                    },
                    loadComplete: function () {
                        $('#Result').jqGrid("setGridWidth", $('#resultDIV').width());
                    },
                    pager: "ResultPagger"
                });
                $("#Result").trigger("reloadGrid");
            }
        }
        function displayLawPhoneCallDate(cellValue, options, rdata, action) {
            var LawPhoneCallNo = rdata.LawPhoneCallNo;
            var LawPhoneCallDate = rdata.LawPhoneCallDate;
            var result = "";
            if(LawPhoneCallNo == 1) {
                result = LawPhoneCallDate;
            } else {
                result = LawPhoneCallDate + "<br><font color=blue>(二次電催日期)</font>";
            }
            return result;
        }
        function displayLawPhoneCallLimitedDate(cellValue, options, rdata, action) {
            var LawPhoneCallNo = rdata.LawPhoneCallNo;
            var LawPhoneCallLimitedDate = rdata.LawPhoneCallLimitedDate;
            var result = "";
            if (LawPhoneCallNo == 1) {
                result = "<font color=red>" + LawPhoneCallLimitedDate + "</font>";
            } else {
                result = "--";
            }
            return result;
        }

    </script>
}

