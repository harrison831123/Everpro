<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <style type="text/css">
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .log-box {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            background: #f9f9f9;
        }

        .message-success {
            color: green;
            font-weight: bold;
        }

        .message-error {
            color: red;
        }

        h3 {
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
    </style>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="/Scripts/jquery-1.6.4.js"></script>
    <!--Reference the SignalR library. -->
    <script src="/Scripts/jquery.signalR-2.2.2.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
</head>
<body>
    <!--<div class="container">
        <input type="text" id="message" />
        <input type="button" id="sendmessage" value="Send" />
        <input type="hidden" id="displayname" />
        <ul id="discussion">
        </ul>
    </div>-->
    <div class="container">
        <h1>🔔 SignalR 通知測試</h1>

        <p>
            **當前模擬的用戶 ID (Context.User.Identity.Name):** <input type="text" id="currentUserId" value="TESTER_A001" readonly style="border: none; font-weight: bold; color: blue;">
        </p>

        <h3>📤 伺服器即時推送日誌</h3>
        <div id="log" class="log-box">
            <p style="color: gray;">等待 SignalR 連線建立...</p>
        </div>

        <hr>

        <h3>🎯 模擬 BPM 系統 (發送 API 請求)</h3>
        <form id="apiTriggerForm">
            <label for="targetUserId">要通知的目標 UserID (Group):</label><br>
            <input type="text" id="targetUserId" name="userID" value="TESTER_A001" required style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>

            <label for="messageContent">通知內容 (Message):</label><br>
            <input type="text" id="messageContent" name="message" value="您有一張新的簽核單待處理: BPM-20251122" required style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>

            <label for="name">發送者/表單名稱 (Name):</label><br>
            <input type="text" id="name" name="name" value="行政表單" style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>

            <label for="systemType">系統類型 (SystemType):</label><br>
            <input type="text" id="systemType" name="systemType" value="BPM" style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>

            <button type="submit" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer;">
                發送 POST 請求到 ToApiController
            </button>
        </form>
        <p id="apiResponse"></p>
    </div>


    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            //    var contosoChatHubProxy = $.connection.contosoChatHub;
            //    contosoChatHubProxy.client.addContosoChatMessageToPage = function (message) {
            //        console.log(message.UserName + ' ' + message.Message);
            //    };
            //    // Get the user name and store it to prepend to messages.
            //    $('#displayname').val(prompt('Enter your name:', ''));
            //    // Set initial focus to message input box.
            //    $('#message').focus();
            //    // Start the connection.
            //    $.connection.hub.start().done(function () {
            //        $('#sendmessage').click(function () {
            //            // Call the Send method on the hub.
            //            contosoChatHubProxy.server.sendMessage($('#displayname').val(), $('#message').val());
            //            // Clear text box and reset focus for next comment.
            //            $('#message').val('').focus();
            //        });
            //    });
            //});
            // ----------------------------------------------------
            // 1. SignalR 連線設定
            // ----------------------------------------------------

            // 取得當前模擬的用戶ID，用於連線時附加到 QueryString (如果必要)
            // 注意：我們假設您的伺服器已經配置了 Forms 或 Windows 驗證來設置 Context.User.Identity.Name
            // 如果您的驗證是透過 QueryString 傳遞，請調整 Hub URL：
            //var targetUserId = $("#targetUserId").val();

            //console.log(targetUserId)
            //var connection = $.hubConnection("/signalr", {
            //    qs: "userid=" + targetUserId
            //});

            //var hub = connection.createHubProxy('SignalRHub'); // 確保 'signalRHub' 與您的 Hub 類別名稱一致

            //// ----------------------------------------------------
            //// 2. 啟動連線
            //// ----------------------------------------------------

            var targetUserId = $("#targetUserId").val();
            var connection = $.hubConnection("/signalr", {
                qs: "userid=" + targetUserId
            });

            var hub = connection.createHubProxy('SignalRHub'); // 確保 'signalRHub' 與您的 Hub 類別名稱一致

            // ----------------------------------------------------
            // 2. 客戶端接收方法 (重點：處理 FormUrl 參數)
            // ----------------------------------------------------

            hub.on('receiveNotice', function () {

            });

            connection.start().done(function () {
                var logEntry = `<p style="color: green;">✔ SignalR 連線成功! Connection ID: ${connection.id}</p>`;
                $("#log").prepend(logEntry);
                console.log('SignalR connected, Connection ID=' + connection.id);
            }).fail(function (error) {
                var logEntry = `<p class="message-error">❌ SignalR 連線失敗: ${error}</p>`;
                $("#log").prepend(logEntry);
                console.error('Could not connect: ' + error);
            });

            // ----------------------------------------------------
            // 3. API 觸發表單處理
            // ----------------------------------------------------
            $("#apiTriggerForm").submit(function (e) {
                e.preventDefault();

                var formData = {
                    userID: $("#targetUserId").val(),
                    message: $("#messageContent").val(),
                    name: $("#name").val(),
                    SystemType: $("#systemType").val(),
                    formUrl:"https://www.google.com/"
                };

                // WebApiConfig: routeTemplate: "SignalRapi/{controller}/{id}"
                var apiUrl = '/SignalRapi/ToApi';

                $("#apiResponse").text("正在發送 API 請求...");

                $.ajax({
                    url: apiUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        $("#apiResponse").html('<span class="message-success">✔ API 請求成功! </span>伺服器回應: ' + JSON.stringify(response));
                        console.log("API Success:", response);
                    },
                    error: function (xhr, status, error) {
                        $("#apiResponse").html('<span class="message-error">❌ API 請求失敗! </span>狀態碼: ' + xhr.status + ' 錯誤: ' + error);
                        console.error("API Error:", xhr.responseText);
                    }
                });
            });
        });
    </script>
</body>
</html>